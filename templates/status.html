<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>学习养成系统状态</title>
    <!-- 引入本地的 Bootstrap CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
库    <!-- 引入自定义样式 -->
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container mt-4">
        <h1>学习养成系统状态</h1>
        <div class="row">
            <div class="col-md-4">
                <p>当前等级: <span id="currentLevel">{{ current_level }}</span></p>
            </div>
            <div class="col-md-4">
                <p>当前小等级: <span id="currentSubLevel">{{ current_sub_level }}</span></p>
            </div>
            <div class="col-md-4">
                <p>当前积分: <span id="currentPoints">{{ current_points }}</span></p>
            </div>
        </div>

        <!-- 删除: <canvas id="pointsChart" width="400" height="200"></canvas> -->
        <!-- 删除: <script> -->
        <!-- 删除: // 获取行为日志数据 -->
        <!-- 删除: const actionLogs = {{ action_logs|tojson }}; -->
        <!-- 删除: const pointsData = actionLogs.map(log => { -->
        <!-- 删除:     const match = log.match(/积分变化: ([+-]?\d+)/); -->
        <!-- 删除:     return match ? parseInt(match[1]) : 0; -->
        <!-- 删除: }); -->
        <!-- 删除:  -->
        <!-- 删除: // 获取时间标签并转换为Date对象 -->
        <!-- 删除: const timeLabels = actionLogs.map(log => { -->
        <!-- 删除:     const match = log.match(/时间: (.+)/); -->
        <!-- 删除:     return match ? new Date(match[1]) : 'N/A'; -->
        <!-- 删除: }); -->
        <!-- 删除:  -->
        <!-- 删除: // 计算累计积分 -->
        <!-- 删除: const cumulativePoints = pointsData.reduce((acc, curr) => { -->
        <!-- 删除:     acc.push(acc[acc.length - 1] + curr); -->
        <!-- 删除:     return acc; -->
        <!-- 删除: }, [0]); -->
        <!-- 删除:  -->
        <!-- 删除: // 创建折线图 -->
        <!-- 删除: const ctx = document.getElementById('pointsChart').getContext('2d'); -->
        <!-- 删除: const chart = new Chart(ctx, { -->
        <!-- 删除:     type: 'line', -->
        <!-- 删除:     data: { -->
        <!-- 删除:         labels: timeLabels,  // 使用时间标签作为X轴 -->
        <!-- 删除:         datasets: [{ -->
        <!-- 删除:             label: '累计积分', -->
        <!-- 删除:             data: cumulativePoints, -->
        <!-- 删除:             borderColor: 'rgba(75, 192, 192, 1)', -->
        <!-- 删除:             borderWidth: 2, -->
        <!-- 删除:             fill: false -->
        <!-- 删除:         }] -->
        <!-- 删除:     }, -->
        <!-- 删除:     options: { -->
        <!-- 删除:         scales: { -->
        <!-- 删除:             x: { -->
        <!-- 删除:                 type: 'time', -->
        <!-- 删除:                 time: { -->
        <!-- 删除:                     unit: 'day',  // 默认时间单位为天 -->
        <!-- 删除:                     tooltipFormat: 'yyyy-MM-dd HH:mm:ss'  // 添加时间提示格式 -->
        <!-- 删除:                 }, -->
        <!-- 删除:                 title: { -->
        <!-- 删除:                     display: true, -->
        <!-- 删除:                     text: '时间' -->
        <!-- 删除:                 } -->
        <!-- 删除:             }, -->
        <!-- 删除:             y: { -->
        <!-- 删除:                 beginAtZero: true, -->
        <!-- 删除:                 title: { -->
        <!-- 删除:                     display: true, -->
        <!-- 删除:                     text: '累计积分' -->
        <!-- 删除:                 } -->
        <!-- 删除:             } -->
        <!-- 删除:         } -->
        <!-- 删除:     } -->
        <!-- 删除: }); -->
        <!-- 删除:  -->
        <!-- 删除: // 添加事件监听器以处理表单提交 -->
        <!-- 删除: document.getElementById('actionForm').addEventListener('submit', function(event) { -->
        <!-- 删除:     event.preventDefault();  // 阻止表单的默认提交行为 -->
        <!-- 删除:  -->
        <!-- 删除:     const formData = new FormData(this); -->
        <!-- 删除:     const action = formData.get('action'); -->
        <!-- 删除:     console.log('Selected action:', action);  // 添加调试日志 -->
        <!-- 删除:  -->
        <!-- 删除:     fetch('/handle_action', { -->
        <!-- 删除:         method: 'POST', -->
        <!-- 删除:         headers: { -->
        <!-- 删除:             'Content-Type': 'application/x-www-form-urlencoded', -->
        <!-- 删除:         }, -->
        <!-- 删除:         body: new URLSearchParams({ action: action }).toString(), -->
        <!-- 删除:     }) -->
        <!-- 删除:     .then(response => { -->
        <!-- 删除:         console.log('Response status:', response.status);  // 添加调试日志 -->
        <!-- 删除:         return response.json(); -->
        <!-- 删除:     }) -->
        <!-- 删除:     .then(data => { -->
        <!-- 删除:         console.log('Received data:', data);  // 添加调试日志 -->
        <!-- 删除:         // 更新页面内容 -->
        <!-- 删除:         document.getElementById('currentLevel').textContent = data.current_level; -->
        <!-- 删除:         document.getElementById('currentSubLevel').textContent = data.current_sub_level; -->
        <!-- 删除:         document.getElementById('currentPoints').textContent = data.current_points; -->
        <!-- 删除:  -->
        <!-- 删除:         // 更新行为日志 -->
        <!-- 删除:         const actionLogsList = document.getElementById('actionLogs'); -->
        <!-- 删除:         actionLogsList.innerHTML = '';  // 清空现有日志 -->
        <!-- 删除:         data.action_logs.forEach(log => { -->
        <!-- 删除:             const li = document.createElement('li'); -->
        <!-- 删除:             li.textContent = log; -->
        <!-- 删除:             actionLogsList.appendChild(li); -->
        <!-- 删除:         }); -->
        <!-- 删除:  -->
        <!-- 删除:         // 更新折线图数据 -->
        <!-- 删除:         const newActionLogs = data.action_logs.map(log => { -->
        <!-- 删除:             const match = log.match(/积分变化: ([+-]?\d+)/); -->
        <!-- 删除:             return match ? parseInt(match[1]) : 0; -->
        <!-- 删除:         }); -->
        <!-- 删除:  -->
        <!-- 删除:         const newTimeLabels = data.action_logs.map(log => { -->
        <!-- 删除:             const match = log.match(/时间: (.+)/); -->
        <!-- 删除:             return match ? new Date(match[1]) : 'N/A'; -->
        <!-- 删除:         }); -->
        <!-- 删除:  -->
        <!-- 删除:         const newCumulativePoints = newActionLogs.reduce((acc, curr) => { -->
        <!-- 删除:             acc.push(acc[acc.length - 1] + curr); -->
        <!-- 删除:             return acc; -->
        <!-- 删除:         }, [0]); -->
        <!-- 删除:  -->
        <!-- 删除:         // 更新图表数据 -->
        <!-- 删除:         chart.data.labels = newTimeLabels; -->
        <!-- 删除:         chart.data.datasets[0].data = newCumulativePoints; -->
        <!-- 删除:         chart.update(); -->
        <!-- 删除:     }) -->
        <!-- 删除:     .catch(error => { -->
        <!-- 删除:         console.error('Error:', error);  // 添加调试日志 -->
        <!-- 删除:     }); -->
        <!-- 删除: }); -->
        <!-- 删除: </script> -->

        <form id="actionForm">
            <div class="form-group">
                <label for="action">选择行为:</label>
                <select name="action" id="action" class="form-control">
                    <option value="没有发脾气">没有发脾气</option>
                    <option value="努力完成学习">努力完成学习</option>
                    <option value="按时睡觉">按时睡觉</option>
                    <option value="发脾气">发脾气</option>
                    <option value="没有完成学习">没有完成学习</option>
                    <option value="没有按时睡觉">没有按时睡觉</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">提交</button>
        </form>
    </div>
    <!-- 引入 Bootstrap JS 和依赖 -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>